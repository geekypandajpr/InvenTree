# Docker compose recipe for InvenTree development server
# Uses Dockerfile.dev which has all environment variables built-in
# No need for external .env files!
#
# Usage:
#   docker compose -f dev-docker-compose.custom.yml up --build

services:

    # Database service
    # Use PostgreSQL as the database backend
    inventree-dev-db:
        image: postgres:17
        expose:
            - 5432/tcp
        environment:
            - PGDATA=/var/lib/postgresql/data/pgdb
            - POSTGRES_USER=pguser
            - POSTGRES_PASSWORD=pgpassword
            - POSTGRES_DB=inventree
        volumes:
          # Map 'data' volume such that postgres database is stored externally
          - ./data:/var/lib/postgresql/data:z
        restart: unless-stopped

    # InvenTree web server service
    # Uses Dockerfile.dev which has all env vars built-in
    inventree-dev-server:
        depends_on:
          - inventree-dev-db
        build:
            context: ../..
            dockerfile: contrib/container/Dockerfile.dev
            target: dev
        # Cache the built image to be used by the inventree-dev-worker process
        image: inventree-dev-custom-image
        ports:
            # Expose web server on port 8000
            - 8000:8000
        volumes:
            # Mount local source directory to /home/sadmin/app/InvenTree
            - ../../:/home/sadmin/app/InvenTree:z
        # No env_file needed - all vars are in Dockerfile.dev!
        restart: unless-stopped

    # Background worker process handles long-running or periodic tasks
    inventree-dev-worker:
        image: inventree-dev-custom-image
        command: invoke worker
        depends_on:
            - inventree-dev-server
        volumes:
            # Mount local source directory to /home/sadmin/app/InvenTree
            - ../../:/home/sadmin/app/InvenTree:z
        # No env_file needed - all vars are in Dockerfile.dev!
        restart: unless-stopped


# Docker compose recipe for InvenTree FULL STACK development
# - Runs PostgreSQL as the database backend
# - Runs Django backend server (port 8000)
# - Runs Vite frontend development server (port 5173)
# - Runs the InvenTree background worker process
# - All services use local source code mounted as volumes
#
# Usage:
#   cd contrib/container
#   docker compose -f dev-docker-compose-full.yml up --build
#
# Access:
#   - Backend API: http://localhost:8000
#   - Frontend UI: http://localhost:5173
#   - Admin Panel: http://localhost:8000/admin

services:

    # Database service
    inventree-dev-db:
        image: postgres:17
        expose:
            - 5432/tcp
        ports:
            - 5432:5432
        environment:
            - PGDATA=/var/lib/postgresql/data/pgdb
            - POSTGRES_USER=pguser
            - POSTGRES_PASSWORD=pgpassword
            - POSTGRES_DB=inventree
        volumes:
          # Map 'data' volume such that postgres database is stored externally
          - ./data:/var/lib/postgresql/data:z
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U pguser -d inventree"]
            interval: 10s
            timeout: 5s
            retries: 5

    # InvenTree BACKEND server
    # Runs Django development server on port 8000
    inventree-dev-backend:
        depends_on:
            inventree-dev-db:
                condition: service_healthy
        build:
            context: ../..
            dockerfile: contrib/container/Dockerfile.dev
            target: dev
        image: inventree-dev-image
        ports:
            # Expose backend server on port 8000
            - 8000:8000
        volumes:
            # Mount local source directory to /home/inventree
            - ../../:/home/inventree:z
        env_file:
            - docker.dev.env
        environment:
            # Ensure frontend can connect to backend
            - INVENTREE_SITE_URL=http://localhost:8000
            - INVENTREE_CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173
        # Override entrypoint to use init.sh from mounted volume
        entrypoint: ["/bin/bash", "/home/inventree/contrib/container/init.sh"]
        command: invoke dev.server -a 0.0.0.0:8000
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/api/"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # InvenTree FRONTEND server
    # Runs Vite development server on port 5173
    inventree-dev-frontend:
        depends_on:
            - inventree-dev-backend
        build:
            context: ../..
            dockerfile: contrib/container/Dockerfile.dev
            target: dev
        image: inventree-dev-image
        ports:
            # Expose frontend server on port 5173
            - 5173:5173
        volumes:
            # Mount local source directory to /home/inventree
            - ../../:/home/inventree:z
        env_file:
            - docker.dev.env
        environment:
            # Frontend environment variables
            - VITE_API_URL=http://localhost:8000
            - VITE_BASE_URL=http://localhost:5173
        # Override entrypoint for frontend - it doesn't need init.sh
        entrypoint: []
        working_dir: /home/inventree/src/frontend
        command: sh -c "yarn install && yarn run compile && yarn run dev --host 0.0.0.0 --port 5173"
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5173"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    # Background worker process handles long-running or periodic tasks
    inventree-dev-worker:
        depends_on:
            - inventree-dev-backend
        image: inventree-dev-image
        volumes:
            # Mount local source directory to /home/inventree
            - ../../:/home/inventree:z
        env_file:
            - docker.dev.env
        # Override entrypoint to use init.sh from mounted volume
        entrypoint: ["/bin/bash", "/home/inventree/contrib/container/init.sh"]
        command: invoke worker
        restart: unless-stopped

